@model List<RSMS.ViewModels.TotalProductInfoModel>
<h1 style="text-align: center;">Store Products</h1>
<link rel="stylesheet" href="~/css/dashboard.css" />
<link rel="stylesheet" href="~/css/viewproducts.css" />
<div style="display: flex; justify-content: center;">
    <p>This is the list of products available in the store.</p>
</div>

<div style="margin-top: 20px; display: flex; justify-content: center;">
    <table class="data-table">
        <caption class="table-caption">List of Store Products</caption>
        <thead>
            <tr>
                <th>Product ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Pretax Price</th>
                @*<th>Photo</th>*@
                <th style="text-wrap:nowrap;">Discount Percent</th>
                <th>Quantity</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var product in Model)
            {
                <tr>

                    <td>@product.ProductId</td>
                    <td>@product.Name</td>
                    <td>@product.Description</td>
                    <td>@product.PriceBeforeTax</td>
                    @if (ViewBag.CurrentUser.RoleId > 6 || ViewBag.CurrentUser.StoreId == ViewBag.StoreId)
                    {
                        <td>
                            <div class="discount-wrapper">
                                <button type="button" class="discount-adjust-btn subtract-btn" data-operation="subtract">-</button>
                                <input type="number" min="0" max="100" name="discountPercent" class="discount-input" value="@product.DiscountPercent" />
                                <button type="button" class="discount-adjust-btn add-btn" data-operation="add">+</button>
                            </div>
                        </td>
                        <td>
                            <div class="quantity-wrapper">
                                <button type="button" class="quantity-adjust-btn subtract-btn" data-operation="subtract">-</button>
                                <input type="number" min="0" max="10000" name="quantity" class="quantity-input" value="@product.Quantity" />
                                <button type="button" class="quantity-adjust-btn add-btn" data-operation="add">+</button>
                            </div>
                        </td>

                    }
                    else
                    {
                        <td>@product.DiscountPercent</td>
                        <td>@product.Quantity</td>
                    }

                    <td style="text-align: center;">
                        <div>
                            <table class="button-column-table" id="buttonColumnTable">
                                <tr>
                                    <td>

                                        @if (ViewBag.CurrentUser.RoleId > 6 || ViewBag.CurrentUser.StoreId == ViewBag.StoreId)
                                        {

                                            <form asp-controller="Product" asp-action="UpdateStoreQtyAndDiscount" method="post" id="UpdateStoreQtyAndDiscount">
                                                <input type="hidden" name="storeId" value="@ViewBag.StoreId" />
                                                <input type="hidden" name="productId" value="@product.ProductId" />
                                                <!-- Hidden input fields to store discount percent and quantity -->
                                                <input type="hidden" name="discountPercent" id="discountPercentInput">
                                                <input type="hidden" name="quantity" id="quantityInput">

                                                <!-- Submit button -->
                                                <button type="submit" class="save-quantity-btn edit-btn">Save</button>
                                            </form>
                                        }
                                        else
                                        {
                                            <button type="submit" class="save-quantity-btn disabled-edit-btn">Save</button>
                                        }

                                    </td>

                                    <td>

                                        @if (ViewBag.CurrentUser.RoleId > 6)
                                        {
                                            <form method="get" action="@Url.Action("EditProductInfo", "Product") ">
                                                <input type="hidden" name="productId" value="@product.ProductId" />
                                                <button type="submit" class="edit-btn">Edit</button>
                                            </form>
                                        }
                                        else
                                        {
                                            <button type="button" class="disabled-edit-btn">Edit</button>
                                        }
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </td>

                </tr>
            }
        </tbody>
    </table>
</div>

<script>
    var discountInput = document.querySelector('.discount-input');
    var quantityInput = document.querySelector('.quantity-input');

    // Get reference to the form
    var form = document.getElementById('updateStoreForm');

    // Function to update hidden inputs
    function updateHiddenInputs() {
        document.getElementById('discountPercentInput').value = discountInput.value;
        document.getElementById('quantityInput').value = quantityInput.value;
    }
    // JavaScript for quantity adjustment and save functionality
    document.querySelectorAll('.quantity-adjust-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const operation = btn.dataset.operation;
            const input = btn.parentElement.querySelector('.quantity-input');
            let quantity = parseInt(input.value);
            if (operation === 'add') {
                quantity++;
            } else if (operation === 'subtract') {
                if (quantity > 1) {
                    quantity--;
                }
            }
            input.value = quantity;
            updateHiddenInputs();
        });
    });
    document.querySelectorAll('.discount-adjust-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const operation = btn.dataset.operation;
            const input = btn.parentElement.querySelector('.discount-input');
            let discount = parseInt(input.value);

            if (operation === 'add') {
                if (discount < 100) {
                    discount++;
                }
            } else if (operation === 'subtract') {
                if (discount > 0) {
                    discount--;
                }
            }

            input.value = discount;
            updateHiddenInputs();
        });
    });

    discountInput.addEventListener('input', updateHiddenInputs);
    quantityInput.addEventListener('input', updateHiddenInputs);
</script>