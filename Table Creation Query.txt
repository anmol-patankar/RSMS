//TODO
ADD FIRSTNAME LASTNAME
ALSO UPDATE ROLE_MAP ON REGISTRATION


GO
CREATE DATABASE RSMS_Test;
GO
use RSMS_Test;
CREATE TABLE Store
(
    store_id INT IDENTITY(0,1) PRIMARY KEY,
    address NVARCHAR(100) NOT NULL,
    rent INT NOT NULL,
	is_open	 BIT DEFAULT 1 NOT NULL,
    is_deleted BIT DEFAULT 0 NOT NULL
);
GO
SET IDENTITY_INSERT Store ON;
INSERT INTO Store ( store_id, Address, Rent, is_open)
VALUES (0, 'Null Store', 0, 0);
SET IDENTITY_INSERT Store OFF;
GO
CREATE TABLE User_Info
(
    user_id UNIQUEIDENTIFIER DEFAULT NEWID() PRIMARY KEY,
	first_name NVARCHAR(100) NOT NULL,
	last_name NVARCHAR(100) NOT NULL,
    username NVARCHAR(100) NOT NULL,
	email NVARCHAR(100) NOT NULL,
	password_hashed VARBINARY(256) NOT NULL,
	salt VARBINARY(256) NOT NULL,
	phone NVARCHAR(13) NOT NULL,
	store_id INT,
	dob date NOT NULL,
	registration_date DATETIME NOT NULL,
	is_disabled BIT DEFAULT 0 NOT NULL,
	FOREIGN KEY(store_id) REFERENCES Store(store_id),
);

CREATE TABLE Role_Map
(
	user_id UNIQUEIDENTIFIER  NOT NULL,
	role_name NVARCHAR(20) NOT NULL,
	FOREIGN KEY(user_id) REFERENCES User_Info(user_id),
	PRIMARY KEY (user_id, role_name),
);


CREATE TABLE Paydesk
(
	paydesk_number INT NOT NULL PRIMARY KEY,
	store_id INT,
	is_manned BIT,
	FOREIGN KEY(store_id) REFERENCES Store(store_id)
);

CREATE TABLE Payroll_History
(
	payroll_id UNIQUEIDENTIFIER DEFAULT NEWID() NOT NULL PRIMARY KEY,
	payee_id UNIQUEIDENTIFIER NOT NULL,
	authorizer_id UNIQUEIDENTIFIER NOT NULL,
	store_id INT NOT NULL,
	transaction_time DATETIME NOT NULL,
	base_amount INT NOT NULL,
	tax_deduction INT NOT NULL
	FOREIGN KEY(payee_id) REFERENCES User_Info(user_id),
	FOREIGN KEY(authorizer_id) REFERENCES User_Info(user_id),
	FOREIGN KEY (store_id) REFERENCES Store(store_id)
);

CREATE TABLE Product_Info
(
	product_id UNIQUEIDENTIFIER  DEFAULT NEWID() NOT NULL PRIMARY KEY,
	product_code NVARCHAR(5) UNIQUE NOT NULL,
	name NVARCHAR(200) NOT NULL,
	description TEXT,
	price_before_tax int NOT NULL,
	photo NVARCHAR(256)
);

CREATE TABLE Product_Stock
(
	product_id UNIQUEIDENTIFIER NOT NULL,
	store_id INT NOT NULL,
	quantity INT NOT NULL,
	discount_percent int NOT NULL,
	FOREIGN KEY(product_id) REFERENCES Product_Info(product_id),
	FOREIGN KEY(store_id) REFERENCES Store(store_id),
	PRIMARY KEY(store_id, product_id)
);

CREATE TABLE Tax_Rate
(
	tax_type INT PRIMARY KEY NOT NULL,
	tax_rate INT NOT NULL
);

CREATE TABLE Product_Taxes
(
	product_id UNIQUEIDENTIFIER NOT NULL,
	tax_type INT NOT NULL,
	FOREIGN KEY(product_id) REFERENCES Product_Info(product_id),
	FOREIGN KEY(tax_type) REFERENCES Tax_Rate(tax_type),
	PRIMARY KEY(product_id, tax_type)
);

CREATE TABLE Transactions
(
	transaction_id UNIQUEIDENTIFIER  DEFAULT NEWID() NOT NULL PRIMARY KEY,
	product_id UNIQUEIDENTIFIER NOT NULL,
	store_id INT  NOT NULL,
	cashier_id UNIQUEIDENTIFIER NOT NULL,
	
	customer_id UNIQUEIDENTIFIER NOT NULL,
	paydesk_number INT NOT NULL,
	FOREIGN KEY(product_id) REFERENCES Product_Info(product_id),
	
	FOREIGN KEY(store_id) REFERENCES Store(store_id),
	
	FOREIGN KEY(cashier_id) REFERENCES User_Info(user_id),
	FOREIGN KEY(customer_id) REFERENCES User_Info(user_id),
	FOREIGN KEY(paydesk_number) REFERENCES Paydesk(paydesk_number),
);

CREATE TABLE Transaction_Details
(
	transaction_id UNIQUEIDENTIFIER PRIMARY KEY  NOT NULL ,
	product_id UNIQUEIDENTIFIER NOT NULL,
	price_before_tax INT NOT NULL,
	tax_amount INT NOT NULL,
	discount_amount INT NOT NULL,
	FOREIGN KEY(transaction_id) REFERENCES Transactions(transaction_id),
	FOREIGN KEY(product_id) REFERENCES Product_Info(product_id),
);
GO
-- Inserting data into User_Info table
INSERT INTO User_Info (user_id, first_name, last_name, username, email, password_hashed, salt, phone, store_id, dob, registration_date, is_disabled)
VALUES ('cb425222-e1d7-40dc-9c65-c417298d1035', 'Anmol', 'Patankar', 'anmol_asterISK', 'anmolpatankar@gmail.com', 0xC2B175785508D30F3FFD824094A19D06, 0xFC875C70269AE88E5EFF0321714CDD59, '9604439891', 0, '2002-07-26', '2024-05-06 11:45:16.197', 0);

-- Inserting data into Role_Map table
INSERT INTO Role_Map (user_id, role_name)
VALUES ('cb425222-e1d7-40dc-9c65-c417298d1035', 'Admin'),
       ('cb425222-e1d7-40dc-9c65-c417298d1035', 'Customer'),
       ('cb425222-e1d7-40dc-9c65-c417298d1035', 'Manager');
GO